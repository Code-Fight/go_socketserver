package Common

import (
	"testing"
)

func TestPacket(t *testing.T) {

	data :=[]byte{0x11,0x11,0x11}
	temp := Packet(uint32(len(data)+17),0x0000,0x1000,0x1004,uint32(len(data)),data)
	t.Logf("%x",temp)
}



func TestUnpack(t *testing.T)  {
	var tmpBuffer []byte
	//声明一个管道用于接收解包的数据
	readerChannel := make(chan []byte, 16)

	testData:=make([][]byte,0)

	//垃圾包 0
	testData= append(testData,[]byte{0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00})
	//正常包 1
	testData= append(testData,[]byte{0x2a,0x00,0x00,0x00,0x0a,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00})
	//一半的包 1
	testData= append(testData,[]byte{0x2a,0x00,0x00,0x00,0x0a,0x00,0x00})
	testData= append(testData,[]byte{0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00})

	//一个多的包 2
	testData= append(testData,[]byte{0x2a,0x00,0x00,0x00,0x0a,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x2a,0x00,0x00,0x00,0x0a,0x00,0x00})
	testData= append(testData,[]byte{0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00})

	//DB上线时 bug测试用例
	testData= append(testData,[]byte{0x2a,0x00,0x00,0x00,0x0b,0x00,0x00,0x00,0x01,0x00,0x10,0x01,0x21,0x00,0x00,0x00,0x01})
	testData= append(testData,[]byte{0x30,0x2a,0x00,0x00,0x00,0x0b,0x00,0x00,0x00,0x01,0x00,0x10,0x01,0x18,0x00,0x00,0x00,0x01,0x30})

	testData=append(testData,[]byte{0x2a,0x00,0x00,0x00,0x34,0x00,0x00,0x00,0x01,0x00,0x10,0x01,0x01,0x00,0x00,0x00,0x2a,0x20,0x0c,0x00,0x00,0x91,0x19,0x00,0x06,0x00,0x09,0x11,0x6c,0xe0,0x66,0x00,0x16,0x80,0x06,0x20,0x01,0xb8,0x00,0x41,0x30,0x19,0x80,0x07,0x55,0x00,0x6d,0x30,0xa8,0x20,0x0b,0x0a,0x58,0xde,0xa3,0x7b,0x1b,0xc0,0x31,0x2a})



	for _, d:=range testData{
		tmpBuffer = Unpack(append(tmpBuffer, d[0:]...), readerChannel)
		//
	}
	close(readerChannel)
	index:=0
	for range readerChannel{
		index++
	}

	if index!=7{
		t.Fatal("TestUnpack Error")
	}


	t.Log("TestUnpack Succ")

}